<!doctype html public "-//w3c//dtd html 4.0 transitional//en">
<html>
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
   <meta name="Author" content="Nikolay Kirov">
   <meta name="GENERATOR" content="Mozilla/4.75 [en] (Win98; U) [Netscape]">
   <title>os4</title>
</head>
<body>
<b>12. Конкуренция: взаимно изключване и синхронизация</b>
<br><b>Семафори. Задача за взаимно изключване.</b>
<br>&nbsp;
<br><b>5.4 Семафори</b>
<br>&nbsp;&nbsp; Основен принцип: два или повече процеса се кооперират
в смисъл на прости сигнали така, че един процес може да бъде спрян на определено
място и да остане в това състояние, докато не получи съответен сигнал.
<br>&nbsp;&nbsp; За да изпрати сигнал чрез семафора&nbsp; <b><tt><font color="#006600">s</font></tt></b>,
процесът трябва да изпълни примитива (процедурата) <b><tt><font color="#006600">signal(s)</font></tt></b>.
За да получи сигнал от семафор <b><tt><font color="#006600">s</font></tt></b>,
процесът трябва да изпълни <b><tt><font color="#006600">wait(s)</font></tt></b>&nbsp;
и ако съответният сигнал още не е изпратен, да остане в състояние на чакане
(блокиран).
<p>&nbsp;&nbsp;&nbsp; Дефинирани са 3 действия с променливата семафор:
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1. Инициализира се с неотрицателно число.
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2. Примитива <b><tt><font color="#006600">wait(s)
</font></tt></b>намалява
стойността на <b><tt><font color="#006600">s</font></tt></b> с 1. Ако стойността
стане отрицателна, процесът (изпълняващ <b><tt><font color="#006600">wait</font></tt></b>)
се блокира.
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3. Операцията <b><tt><font color="#006600">signal(s)
</font></tt></b>увеличава
стойността на <b><tt><font color="#006600">s</font></tt></b> с 1. Ако стойността
не е положителна, процесът (блокиран с <b><tt><font color="#006600">wait</font></tt></b>)
се разблокира.
<br>&nbsp;&nbsp;&nbsp; Примитивите <b><tt><font color="#006600">wait </font></tt></b>и
<b><tt><font color="#006600">signal
</font></tt></b>се предполат неделими, т.е. те не могат да бъдат прекъсвани.
<p><b><tt><font color="#006600">struct semaphore {</font></tt></b>
<br><b><tt><font color="#006600">&nbsp;int count;</font></tt></b>
<br><b><tt><font color="#006600">&nbsp;queueType queue;</font></tt></b>
<br><b><tt><font color="#006600">};</font></tt></b>
<table BORDER CELLSPACING=0 CELLPADDING=4 COLS=2 WIDTH="100%" >
<tr>
<td><b><tt><font color="#003300">void wait(semaphore s)</font></tt></b>
<br><b><tt><font color="#003300">{</font></tt></b>
<br><b><tt><font color="#003300">&nbsp;s.count--;</font></tt></b>
<br><b><tt><font color="#003300">&nbsp;if (s.count &lt; 0)</font></tt></b>
<br><b><tt><font color="#003300">&nbsp;{</font></tt></b>
<br><b><tt><font color="#006600">&nbsp; </font><font color="#660000">place_this_process_in_s.queue;</font></tt></b>
<br><b><tt><font color="#660000">&nbsp; block_this_process;</font></tt></b>
<br><b><tt><font color="#006600">&nbsp;</font><font color="#003300">}</font></tt></b>
<br><b><tt><font color="#003300">}</font></tt></b></td>

<td><b><tt><font color="#003300">void signal(semaphore s)</font></tt></b>
<br><b><tt><font color="#003300">{</font></tt></b>
<br><b><tt><font color="#003300">&nbsp;s.count++;</font></tt></b>
<br><b><tt><font color="#003300">&nbsp;if (s.count &lt;= 0)</font></tt></b>
<br><b><tt><font color="#003300">&nbsp;{</font></tt></b>
<br><b><tt><font color="#660000">&nbsp; remove_a_process_from_s.queue(P);</font></tt></b>
<br><b><tt><font color="#660000">&nbsp; place_the_process_on_ready_list(P);</font></tt></b>
<br><b><tt><font color="#003300">&nbsp;}</font></tt></b>
<br><b><tt><font color="#003300">}</font></tt></b></td>
</tr>
</table>

<p>&nbsp;&nbsp;&nbsp; Пример.
<br>--- FIGURE 5.8 ---
<br>Ако <b><tt><font color="#003300">s.count </font></tt></b>е отрицателно
число (3, 6 и 7), -<font color="#003300"><b><tt>s.count</tt></b> е броят
на чакащите на семафора&nbsp; <b><tt>s</tt></b> процеси, т.е. броят на
процесите в опашката </font><b><tt><font color="#660000">s.queue</font></tt></b>.&nbsp;
Ако <b><tt><font color="#003300">s.count </font></tt></b>е положително
число (1), <font color="#003300"><b><tt>s.count</tt></b> е броят на процесите,
които могат да минат през семафора, преди той да се затвори. Опашката </font><b><tt><font color="#660000">s.queue</font></tt></b>
е празна. Ако <b><tt><font color="#003300">s.count </font></tt></b>е 1
(1), то един процес минава и затваря семафора. Ако <b><tt><font color="#003300">s.count
</font></tt></b>е
0 (2, 4 и 5), то идващ процес се блокира и отива на опашката.
<p>&nbsp;&nbsp; Двоични семафори - семафорът има две състояния - отворен
(1) и затворен (0):
<br><b><tt><font color="#006600">struct binary_semaphore {</font></tt></b>
<br><b><tt><font color="#006600">int value; /* = 0, 1 */</font></tt></b>
<br><b><tt><font color="#006600">queueType queue;</font></tt></b>
<br><b><tt><font color="#006600">};</font></tt></b>
<table BORDER CELLSPACING=0 CELLPADDING=4 COLS=2 WIDTH="100%" >
<tr>
<td><b><tt><font color="#006600">void waitB(binary_semaphore s)</font></tt></b>
<br><b><tt><font color="#006600">{</font></tt></b>
<br><b><tt><font color="#006600">&nbsp;if (s.value==1) s.value=0;</font></tt></b>
<br><b><tt><font color="#006600">&nbsp;else</font></tt></b>
<br><b><tt><font color="#006600">&nbsp;{</font></tt></b>
<br><b><tt><font color="#006600">&nbsp; </font><font color="#660000">place_this_process_in_s.queue;</font></tt></b>
<br><b><tt><font color="#660000">&nbsp; block_this_process;</font></tt></b>
<br><b><tt><font color="#006600">&nbsp;}</font></tt></b>
<br><b><tt><font color="#006600">}</font></tt></b></td>

<td><b><tt><font color="#006600">void signalB(binary_semaphore s)</font></tt></b>
<br><b><tt><font color="#006600">{</font></tt></b>
<br><b><tt><font color="#006600">&nbsp;if (s.queue.is_empty()) s.value=1;</font></tt></b>
<br><b><tt><font color="#006600">&nbsp;else</font></tt></b>
<br><b><tt><font color="#006600">&nbsp;{</font></tt></b>
<br><b><tt><font color="#006600">&nbsp; </font><font color="#660000">remove_a_process_from
s.queue(P);</font></tt></b>
<br><b><tt><font color="#660000">&nbsp; place_process_on_ready_list(P);</font></tt></b>
<br><b><tt><font color="#006600">&nbsp;}</font></tt></b>
<br><b><tt><font color="#006600">}</font></tt></b></td>
</tr>
</table>

<p>** Взаимно изключване - решение на задачата за ВИ със семафори.
<br><b><tt><font color="#003300">/* program mutual_exclusion */</font></tt></b>
<br><b><tt><font color="#003300">const int n; /* number of processes */</font></tt></b>
<br><b><tt><font color="#003300">semaphore s = 1;</font></tt></b>
<br><b><tt><font color="#003300">void P(int i)</font></tt></b>
<br><b><tt><font color="#003300">{</font></tt></b>
<br><b><tt><font color="#003300">&nbsp;while (true)</font></tt></b>
<br><b><tt><font color="#003300">&nbsp;{</font></tt></b>
<br><b><tt><font color="#003300">&nbsp; wait(s);</font></tt></b>
<br><b><tt><font color="#003300">&nbsp; &lt;critical section></font></tt></b>
<br><b><tt><font color="#003300">&nbsp; signal(s);</font></tt></b>
<br><b><tt><font color="#003300">&nbsp; &lt;remainder></font></tt></b>
<br><b><tt><font color="#003300">&nbsp;}</font></tt></b>
<br><b><tt><font color="#003300">}</font></tt></b>
<br><b><tt><font color="#003300">void main()</font></tt></b>
<br><b><tt><font color="#003300">{</font></tt></b>
<br><b><tt><font color="#003300">&nbsp;parbegin(P(1), P(2),..., P(n));</font></tt></b>
<br><b><tt><font color="#003300">}</font></tt></b>
<br>&nbsp;&nbsp;&nbsp; Стойността на променливата <b><tt><font color="#003300">s.count
</font></tt></b>има
следния смисъл:
<br>- <b><tt><font color="#003300">s.count >= 0 </font></tt></b>е броят
на процесите, които могат да изпълнят примитива <b><tt><font color="#006600">wait(s)</font></tt></b>без
да бъдат блокирани (и няма изпълнение на <b><tt><font color="#006600">signal(s)</font></tt></b>);
<br>- <b><tt><font color="#003300">s.count &lt; 0 </font></tt></b>е броят
на процесите, чакащи в <b><tt><font color="#006600">s.queue.</font></tt></b>
<br>
<hr WIDTH="100%">
</body>
</html>
